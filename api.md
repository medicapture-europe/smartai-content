# ðŸŒ MediCapture MVR API Documentation Overview

This document summarizes the remote operation protocol for MediCapture MVR/MTR devices, covering session management, core commands, streaming, and the RS232 serial connection variant.

* **Base Protocol:** HTTP (REST principles) over TCP/IP.
* **Base URL Example:** `http://[MVR IP Address]:3333/api/`

---

## 1. ðŸ”‘ Connection and Authorization

### 1.1. Access and Session Management
| Feature | Description |
| :--- | :--- |
| **Enabling API** | Disabled by default. Must be enabled in **Settings > Advanced > Connections > Remote Access**. |
| **Exclusivity** | Remote control is typically **exclusive** to direct use (UI) to prevent conflicts. It is only allowed when the MVR is at the **Start screen** (idle). |
| **Session ID** | A unique ID generated by the MVR during the **`begin`** command. Required for all subsequent requests via the **`X-session`** header. |
| **Session Timeout** | $\approx 5 \text{ minutes}$ of inactivity automatically closes the session. |
| **Forcible Break** | Holding the **Patient button** on the device for $\approx 10 \text{ seconds}$ closes the active remote session. |

### 1.2. Authentication (`/api/begin`)
Authorization is sent during the `begin` call using standard HTTP authentication:

* **Format:** `Authorization: Basic <base64(<user>:<md5(pass)>)>`
    * The password must be encoded using an **MD5 transform**.

### 1.3. Key System Commands
| Command | Method | Function |
| :--- | :--- | :--- |
| `/api/begin` | `POST` | Starts a remote session and returns the Session ID. |
| `/api/end` | `POST` | Ends the remote session and returns MVR to the idle state. |
| `/api/ping` | `GET` | Keep-alive command to ensure the session remains active. |
| `/api/device` | `GET` | **Discovery command.** Returns basic device info (firmware, serial, etc.) and requires **no authorization**. |
| `/api/system/reboot` | `PUT` | Reboots the MVR device. |
| `/api/system/format/<type>` | `PUT` | Formats specified storage (`USB` or `INTERNAL`). |
| `/api/system/reset_settings` | `PUT` | Resets all settings to default. |
| `/api/system/factory_reset` | `PUT` | Resets the entire device to factory settings. |
| `/api/system/firmware` | `POST` | Uploads the firmware file (`*.upd`) as a binary stream and reboots to update. |
| `/api/input/key/<code>` | `PUT` | Sends a key code (e.g., for system functions, zoom) to the MVR UI. Works without an active session (requires standard authorization). |
| `/api/storage/eject/USB` | `PUT` | Safely ejects the USB storage for physical removal. |

---

## 2. ðŸŽ¬ Active Study and Media Control

These commands require an active remote session to function.

| Category | Command Examples | Function |
| :--- | :--- | :--- |
| **Study Management** | `PUT /api/study/start` | Starts a new study (accepts DICOM/Patient JSON data). |
| | `GET /api/study/status` | Gets the current study state (`recordState`, storages, etc.). |
| **Capture/Record** | `PUT /api/study/snapshot` | Captures an image to all enabled storages. |
| | `PUT /api/study/record/start` | Starts video recording. |
| | `PUT /api/study/record/pause` | Pauses video recording. |
| **Custom Overlays** | `POST /api/study/overlays` | Creates a new overlay (rectangle, background, text/image elements). |
| | `PUT /api/study/overlays/<id>` | Updates the properties of an existing overlay (e.g., changes text, color). |
| **Camera/Display** | `PUT /api/study/camera/swap` | Swaps the primary and secondary video sources. |
| | `PUT /api/study/finish` | Finishes the current study. |

---

## 3. ðŸ’¾ Storage, Settings, and Status

| Category | Command Examples | Function |
| :--- | :--- | :--- |
| **Storage Access** | `GET /api/storages` | Lists all available storages (`INTERNAL`, `USB`, `NETWORK`). |
| | `GET /api/folders/<type>/<path>` | Lists contents of a folder. |
| | `GET /api/files/<type>/<path>` | Retrieves the raw binary stream of a file (e.g., download content). |
| **Settings** | `GET /api/settings` | Retrieves all defined device settings. |
| | `PUT /api/settings` | Updates specified settings fields (e.g., `video_codec`, `internal_storage`). |
| **DICOM/PACS** | `POST /api/pacs` | Schedules files from Internal Storage to be uploaded to PACS. |
| | `GET /api/worklist` | Retrieves the DICOM Modality Worklist (MWL) from the server. |
| **Logging** | `GET /api/logs` | Retrieves the Audit Log of critical device and user actions. |

---

## 4. ðŸš€ Asynchronous Communication and Streaming

### 4.1. Notifications (`/api/notify`)
* `GET /api/notify` creates a persistent HTTP connection to receive real-time, asynchronous updates from the MVR.
* **Data Format:** JSON objects sent in a continuous stream using chunked transfer encoding.
* **Monitored Events:** Storage status, camera signal changes, recording state changes (`studyRecordState`), and PACS upload status (`pacsFileStatus`).

### 4.2. Live Streaming
* **Authorization:** Separate from the API session; uses a PIN obtained via `/api/stream/authorize`.
* **Streams:**
    * `GET /api/stream/video?pin=<pin>`: Returns a continuous, low-latency video stream (fragmented-mp4).
    * `GET /api/stream/audio?pin=<pin>`: Returns an audio stream (AAC/ADTS).

---

## 5. ðŸ§² RS232 Serial Connection Protocol

The API can also be accessed via a USB serial connection (RS232 protocol) with specific variations.

| Feature | HTTP Protocol | RS232 Serial Protocol |
| :--- | :--- | :--- |
| **Session ID** | Explicitly sent in `X-session` header. | **Not required**; each connection has an automatic session ID. |
| **Request Format** | `METHOD /path` (Standard HTTP) | `<method> <path> [<command-id>] [<optional data>]\n` |
| **Authentication** | `Authorization: Basic...` in HTTP header. | User/pass sent directly in the `begin` command JSON: `{"user": "u", "pass": "p"}` |
| **File Transfer** | Sent as standard binary stream. | Sent as binary data preceded by a null byte (`\0`), followed by the file size. |
| **Notifications** | Cancelled by closing the HTTP connection. | Cancelled using the explicit `CANCEL <command-id>` command. |
